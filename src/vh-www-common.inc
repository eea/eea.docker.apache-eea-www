# Common rules to be used for all the configurations to be used with apache include directive

    # Set X-username header based on cookie to differentiate the anonymous and CMS users
    SetEnvIf Cookie "__ac=\"(.+?)\";" auth_username=$1
    SetEnvIf Cookie "plone_skin=\"(.+)?\"" auth_skin=$1
    RequestHeader set X-Username "%{auth_username}e|%{auth_skin}e" env=auth_username
    RequestHeader set X-Username Anonymous env=!auth_username

    DocumentRoot /var/www-static-resources
    <Directory /var/www-static-resources>
      AllowOverride None
      Require all granted
    </Directory>

    RewriteEngine On

    Alias /errors /var/www-static-resources/errors

    LogLevel alert rewrite:info

    # Avoid virtual_hosting error with multiple port numbers
    RewriteCond %{HTTP_HOST} : 
    RewriteRule / http://www.eea.europa.eu [L]

    # 81010 restrict PUT DELETE PATCH PURGE PROPFIND TRACE directly from apache
	  TraceEnable off
    <Location />
        <Limit PATCH PURGE PROPFIND>
            order deny,allow
            deny from all
        </Limit>
    </Location>
    <Location /getUserInformation>
      Order Deny,Allow
      Allow from 10.92.0.0/16
      Allow from eea.europa.eu
      Deny from all
    </Location>
    <LocationMatch "(?i)phpMyAdmin">
      Require all denied
    </LocationMatch>
    <Location />
      AddOutputFilterByType DEFLATE text/plain
      AddOutputFilterByType DEFLATE text/xml
      AddOutputFilterByType DEFLATE application/xhtml+xml
      AddOutputFilterByType DEFLATE text/css
      AddOutputFilterByType DEFLATE application/xml
      AddOutputFilterByType DEFLATE image/svg+xml
      AddOutputFilterByType DEFLATE application/rss+xml
      AddOutputFilterByType DEFLATE application/atom_xml
      AddOutputFilterByType DEFLATE application/x-javascript
      AddOutputFilterByType DEFLATE application/x-httpd-php
      AddOutputFilterByType DEFLATE application/x-httpd-fastphp
      AddOutputFilterByType DEFLATE application/x-httpd-eruby
      AddOutputFilterByType DEFLATE text/html
      AddOutputFilterByType DEFLATE text/javascript
    </Location>

    # Allow PUT and DELETE only for inline comments
    RewriteCond %{REQUEST_METHOD} PUT [or]
    RewriteCond %{REQUEST_METHOD} DELETE
    RewriteCond %{REQUEST_URI} !annotator.api
    RewriteRule .* /errors/405msg.html [L,R=405]

    # Turn off MultiViews
    Options -MultiViews

    # Redirect to www.
    RewriteCond %{HTTP_HOST} =eea.europa.eu
    RewriteRule ^/(.*) %{REQUEST_SCHEME}://www.eea.europa.eu/$1 [R=permanent,L]

    # Protect from illegal request
    RewriteRule ^/.*\.dll$ /404 [L]
    RewriteRule ^/.*\.php$ /404 [L]
    RewriteRule ^/.*\.asp$ /404 [L]
    RewriteRule ^/_vti_.* /404 [L]
    RewriteRule ^/.*/Calendar/(.*)allYearEvents(.*) /404 [L]

    RewriteRule ^/index_html$ / [R=permanent,L]
    RewriteRule ^/index.htm$ / [R=permanent,L]
    RewriteRule ^/index.html$ / [R=permanent,L]
    RewriteRule ^/main_html(.*) / [R=permanent,L]

    # See Products.EEAEnquiry
    RewriteRule ^/(.*)/getUserInformation(.*) /getUserInformation$2 [R=permanent,L]

    # Due to ticket 4947: there is no reason to view these pages, the links are generated by @@rdf
    RewriteRule ^/portal_factory/(.*)/rdfstype(.*) / [R=permanent,L]

    # English language removal
    RewriteRule ^/en/(.*) /$1 [R=permanent]
    RewriteRule ^/SITE(.*) /$1 [R=permanent]
    RewriteRule ^/www/SITE(.*) /$1 [R=permanent]

    # Rewrite the UID request
    RewriteRule ^/data-and-maps/([A-Z0-9]{8}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{12}) /data-and-maps/ds_resolveuid/$1   [R=permanent,L]

    # Integration of the PAM site into a subfolder of WWW (taskman ticket #16986)
    RewriteRule ^/themes/climate/pam http://pam.apps.eea.europa.eu [R=permanent,L]
    RewriteRule ^/data-and-maps/pam http://pam.apps.eea.europa.eu [R=permanent,L]
    RewriteRule ^/data-and-maps/data/data-viewers/pam  http://pam.apps.eea.europa.eu [R=permanent,L]

    # Template service v2 , 21 June 2012
    RewriteRule ^/templates/v2/getRequiredHead /getRequiredHead
    RewriteRule ^/templates/v2/getHeader       /getHeader
    RewriteRule ^/templates/v2/getFooter       /getFooter

    RewriteRule ^/templates/v2/(..)/getRequiredHead /$1/getRequiredHead
    RewriteRule ^/templates/v2/(..)/getHeader       /$1/getHeader
    RewriteRule ^/templates/v2/(..)/getFooter       /$1/getFooter

    # Legal
    RewriteRule ^/coreset /data-and-maps/indicators [R,L]
    RewriteRule ^/copyright(.*) /legal/copyright$1 [R=permanent,L]
    RewriteRule ^/disclaimer(.*) /legal/disclaimer$1 [R=permanent,L]

    # SOER 2015 Launch rewrite rules. Ticket #22698#note-4
    RewriteRule ^/soer-2015$ /soer [R=permanent,L]
    RewriteRule ^/soer-2015/$ /soer [R=permanent,L]
    RewriteRule ^/soer-2015/view$ /soer [R=permanent,L]
    #RewriteRule ^/soer-2015/soer2015_frontpage$ /soer [R=permanent,L]

    # Rewrite RSS to RSS2 - this should be removed once the RSS enabling issue is fixed
    RewriteRule ^/(.*)highlights.rdf$ /$1highlights/archive/RSS2 [R,L]
    RewriteRule ^/(.*)reports.rdf$ /$1publications/latest/RSS2 [R,L]

    # Directive to ensure *.rdf files served as appropriate content type, if not present in main apache config
    AddType application/rdf+xml .rdf

    # Rewrite rule to serve RDF data from the proper location when Agent accepts the RDF data
    RewriteCond %{HTTP_ACCEPT} application/rdf\+xml.*
    RewriteCond %{REQUEST_URI} !^.*(@@rdf\/?|\.xml|\.rdf|\.rss|RSS|RSS2)$
    RewriteRule ^/(.*\/)$ $1@@rdf [R=303,L]

    RewriteCond %{HTTP_ACCEPT} application/rdf\+xml.*
    RewriteCond %{REQUEST_URI} !^.*(@@rdf\/?|\.xml|\.rdf|\.rss|RSS|RSS2)$
    RewriteRule ^/(.*)$ $1/@@rdf [R=303,L]

    # Control panel admin pages redirect to /www/.*
    RewriteRule ^/plone_control_panel(.*) /www/@@overview-controlpanel$1 [R=permanent,L,NE]
    RewriteRule ^/prefs_(.*) /www/prefs_$1 [R=permanent,L,NE]

    RewriteCond %{REQUEST_URI} !\.png$
    RewriteCond %{REQUEST_URI} !\.jpg$
    RewriteCond %{REQUEST_URI} !\.gif$
    RewriteCond %{REQUEST_URI} !\.css$
    RewriteCond %{REQUEST_URI} !\.js$
    RewriteRule ^/\+\+(.*) /www/++$1 [R=permanent,L,NE]

    RewriteCond %{REQUEST_URI} !^/@@rdf
    RewriteCond %{REQUEST_URI} !^/@@eea\.controlpanel
    RewriteCond %{REQUEST_URI} !^/@@manage-viewlets
    RewriteCond %{REQUEST_URI} !^/@@manage-portlets
    RewriteRule ^/@@(.*) /www/@@$1 [R=permanent,L,NE]

    # zc.async queue 27705
    RewriteRule ^/jobs.json(.*) /www/jobs.json$1 [R=permanent,L,NE]

    # Due to #4836: fix for @@images
    RewriteRule ^(.*)/@@images/image/(.*) $1/image_$2 [R=permanent,L]
    
    # "Countries and regions" integration, see #81581

    ### CaR resources
    RewriteRule ^/countries-and-regions/car.facetview.js(.*) http://87.248.32.84:3003/car.facetview.js$1 [P,L]
    RewriteRule ^/countries-and-regions/car.facet.js(.*) http://87.248.32.84:3003/car.facet.js$1 [P,L]
    RewriteRule ^/countries-and-regions/car.facetview.css(.*) http://87.248.32.84:3003/car.facetview.css$1 [P,L]
    RewriteRule ^/countries-and-regions/facetview(.*) http://87.248.32.84:3003/facetview$1 [P,L]
    RewriteRule ^/countries-and-regions/css(.*) http://87.248.32.84:3003/css$1 [P,L]
    RewriteRule ^/countries-and-regions/javascripts(.*) http://87.248.32.84:3003/javascripts$1 [P,L]
    RewriteRule ^/countries-and-regions/api(.*) http://87.248.32.84:3003/api$1 [P,L]
    RewriteRule ^/countries-and-regions/download(.*) http://87.248.32.84:3003/download$1 [P,L]
    RewriteRule ^/countries-and-regions/images(.*) http://87.248.32.84:3003/images$1 [P,L]

    ### CaR - EEA member countries
    RewriteRule ^/countries-and-regions/austria/$ /countries-and-regions/austria [R]
    RewriteRule ^/countries-and-regions/austria$ http://87.248.32.84:3003/austria [P,L]
    RewriteRule ^/countries-and-regions/belgium(.*) http://87.248.32.84:3003/belgium$1 [P,L]
    RewriteRule ^/countries-and-regions/bulgaria(.*) http://87.248.32.84:3003/bulgaria$1 [P,L]
    RewriteRule ^/countries-and-regions/croatia(.*) http://87.248.32.84:3003/croatia$1 [P,L]
    RewriteRule ^/countries-and-regions/cyprus(.*) http://87.248.32.84:3003/cyprus$1 [P,L]
    RewriteRule ^/countries-and-regions/czech-republic(.*) http://87.248.32.84:3003/czech-republic$1 [P,L]
    RewriteRule ^/countries-and-regions/denmark(.*) http://87.248.32.84:3003/denmark$1 [P,L]
    RewriteRule ^/countries-and-regions/estonia(.*) http://87.248.32.84:3003/estonia$1 [P,L]
    RewriteRule ^/countries-and-regions/finland(.*) http://87.248.32.84:3003/finland$1 [P,L]
    RewriteRule ^/countries-and-regions/france(.*) http://87.248.32.84:3003/france$1 [P,L]
    RewriteRule ^/countries-and-regions/germany(.*) http://87.248.32.84:3003/germany$1 [P,L]
    RewriteRule ^/countries-and-regions/greece(.*) http://87.248.32.84:3003/greece$1 [P,L]
    RewriteRule ^/countries-and-regions/hungary(.*) http://87.248.32.84:3003/hungary$1 [P,L]
    RewriteRule ^/countries-and-regions/iceland(.*) http://87.248.32.84:3003/iceland$1 [P,L]
    RewriteRule ^/countries-and-regions/ireland(.*) http://87.248.32.84:3003/ireland$1 [P,L]
    RewriteRule ^/countries-and-regions/italy(.*) http://87.248.32.84:3003/italy$1 [P,L]
    RewriteRule ^/countries-and-regions/latvia(.*) http://87.248.32.84:3003/latvia$1 [P,L]
    RewriteRule ^/countries-and-regions/liechtenstein(.*) http://87.248.32.84:3003/liechtenstein$1 [P,L]
    RewriteRule ^/countries-and-regions/lithuania(.*) http://87.248.32.84:3003/lithuania$1 [P,L]
    RewriteRule ^/countries-and-regions/luxembourg(.*) http://87.248.32.84:3003/luxembourg$1 [P,L]
    RewriteRule ^/countries-and-regions/malta(.*) http://87.248.32.84:3003/malta$1 [P,L]
    RewriteRule ^/countries-and-regions/norway(.*) http://87.248.32.84:3003/norway$1 [P,L]
    RewriteRule ^/countries-and-regions/poland(.*) http://87.248.32.84:3003/poland$1 [P,L]
    RewriteRule ^/countries-and-regions/portugal(.*) http://87.248.32.84:3003/portugal$1 [P,L]
    RewriteRule ^/countries-and-regions/romania/$ /countries-and-regions/romania [R]
    RewriteRule ^/countries-and-regions/romania$ http://87.248.32.84:3003/romania [P,L]
    RewriteRule ^/countries-and-regions/serbia(.*) http://87.248.32.84:3003/serbia$1 [P,L]
    RewriteRule ^/countries-and-regions/slovakia(.*) http://87.248.32.84:3003/slovakia$1 [P,L]
    RewriteRule ^/countries-and-regions/slovenia(.*) http://87.248.32.84:3003/slovenia$1 [P,L]
    RewriteRule ^/countries-and-regions/spain(.*) http://87.248.32.84:3003/spain$1 [P,L]
    RewriteRule ^/countries-and-regions/sweden(.*) http://87.248.32.84:3003/sweden$1 [P,L]
    RewriteRule ^/countries-and-regions/switzerland(.*) http://87.248.32.84:3003/switzerland$1 [P,L]
    RewriteRule ^/countries-and-regions/netherlands(.*) http://87.248.32.84:3003/netherlands$1 [P,L]
    RewriteRule ^/countries-and-regions/turkey(.*) http://87.248.32.84:3003/turkey$1 [P,L]
    RewriteRule ^/countries-and-regions/united-kingdom(.*) http://87.248.32.84:3003/united-kingdom$1 [P,L]

    ### CaR - Collaborating countries
    RewriteRule ^/countries-and-regions/albania(.*) http://87.248.32.84:3003/albania$1 [P,L]
    RewriteRule ^/countries-and-regions/bosnia-and-herzegovina(.*) http://87.248.32.84:3003/bosnia-and-herzegovina$1 [P,L]
    RewriteRule ^/countries-and-regions/kosovo(.*) http://87.248.32.84:3003/kosovo$1 [P,L]
    RewriteRule ^/countries-and-regions/fyr-macedonia(.*) http://87.248.32.84:3003/fyr-macedonia$1 [P,L]
    RewriteRule ^/countries-and-regions/montenegro(.*) http://87.248.32.84:3003/montenegro$1 [P,L]

    ### CaR - Regions
    RewriteRule ^/countries-and-regions/arctic(.*) http://87.248.32.84:3003/arctic$1 [P,L]
    RewriteRule ^/countries-and-regions/black-sea(.*) http://87.248.32.84:3003/black-sea$1 [P,L]
    RewriteRule ^/countries-and-regions/mediterranean(.*) http://87.248.32.84:3003/mediterranean$1 [P,L]


    ############################################################################
    # WARNING: DO NOT add anything else bellow. Add new rules above this comment
    ############################################################################
    RewriteCond %{REQUEST_URI} !^/server-status$
    RewriteCond %{REQUEST_URI} !^/errors/(.*)\.html$
    RewriteCond %{REQUEST_URI} !^/portal_css/(.*)\.css$
    RewriteCond %{REQUEST_URI} !^/portal_javascripts/(.*)\.js$
