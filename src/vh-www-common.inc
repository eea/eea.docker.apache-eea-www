# Common rules to be used for all the configurations to be used with apache include directive

    # Set X-username header based on cookie to differentiate the anonymous and CMS users
    SetEnvIf Cookie "__ac=\"(.+?)\";" auth_username=$1
    SetEnvIf Cookie "plone_skin=\"(.+)?\"" auth_skin=$1
    RequestHeader set X-Username "%{auth_username}e|%{auth_skin}e" env=auth_username
    RequestHeader set X-Username Anonymous env=!auth_username

    # Brotli compression
    BrotliCompressionQuality 10
    BrotliCompressionWindow 22

    DocumentRoot /var/www-static-resources
    <Directory /var/www-static-resources>
      AllowOverride None
      Require all granted
    </Directory>

    RewriteEngine On

    Alias /errors /var/www-static-resources/errors

    LogLevel alert rewrite:info

    # Avoid virtual_hosting error with multiple port numbers
    RewriteCond %{HTTP_HOST} :
    RewriteRule / https://www.eea.europa.eu [L]

    # 81010 restrict PUT DELETE PATCH PURGE PROPFIND TRACE directly from apache
    TraceEnable off
    <Location />
        <Limit PATCH PURGE PROPFIND>
            order deny,allow
            deny from all
        </Limit>
    </Location>
    <Location /getUserInformation>
      Order Deny,Allow
      Allow from 10.92.0.0/16
      Allow from eea.europa.eu
      Deny from all
    </Location>
    <LocationMatch "(?i)phpMyAdmin">
      Require all denied
    </LocationMatch>
    <Location />
      AddOutputFilterByType BROTLI_COMPRESS text/plain
      AddOutputFilterByType BROTLI_COMPRESS text/xml
      AddOutputFilterByType BROTLI_COMPRESS application/xhtml+xml
      AddOutputFilterByType BROTLI_COMPRESS text/css
      AddOutputFilterByType BROTLI_COMPRESS application/xml
      AddOutputFilterByType BROTLI_COMPRESS image/svg+xml
      AddOutputFilterByType BROTLI_COMPRESS application/rss+xml
      AddOutputFilterByType BROTLI_COMPRESS application/atom_xml
      AddOutputFilterByType BROTLI_COMPRESS application/x-javascript
      AddOutputFilterByType BROTLI_COMPRESS application/x-httpd-php
      AddOutputFilterByType BROTLI_COMPRESS application/x-httpd-fastphp
      AddOutputFilterByType BROTLI_COMPRESS application/x-httpd-eruby
      AddOutputFilterByType BROTLI_COMPRESS text/html
      AddOutputFilterByType BROTLI_COMPRESS text/javascript
      AddOutputFilterByType BROTLI_COMPRESS application/javascript
    </Location>

    # Allow PUT and DELETE only for inline comments
    RewriteCond %{REQUEST_METHOD} PUT [or]
    RewriteCond %{REQUEST_METHOD} DELETE
    RewriteCond %{REQUEST_URI} !annotator.api
    RewriteRule .* /errors/405msg.html [L,R=405]

    # Turn off MultiViews
    Options -MultiViews

    # Redirect to www.
    RewriteCond %{HTTP_HOST} =eea.europa.eu
    RewriteRule ^/(.*) https://www.eea.europa.eu/$1 [R=permanent,L]

    # Protect from illegal request
    RewriteRule ^/.*\.dll$ /404 [L]
    RewriteRule ^/.*\.php$ /404 [L]
    RewriteRule ^/.*\.asp$ /404 [L]
    RewriteRule ^/_vti_.* /404 [L]
    RewriteRule ^/(.*)/Calendar/(.*)allYearEvents(.*) /404 [L]

    RewriteRule ^/index_html$ / [R=permanent,L]
    RewriteRule ^/index.htm$ / [R=permanent,L]
    RewriteRule ^/index.html$ / [R=permanent,L]
    RewriteRule ^/main_html(.*) / [R=permanent,L]

    # See Products.EEAEnquiry
    RewriteRule ^/(.*)/getUserInformation(.*) /getUserInformation$2 [R=permanent,L]

    # Due to ticket 4947: there is no reason to view these pages, the links are generated by @@rdf
    RewriteRule ^/portal_factory/(.*)/rdfstype(.*) / [R=permanent,L]

    # English language removal
    RewriteRule ^/en/(.*) /$1 [R=permanent]
    RewriteRule ^/SITE(.*) /$1 [R=permanent]
    RewriteRule ^/www/SITE(.*) /$1 [R=permanent]

    # Rewrite the UID request
    RewriteRule ^/data-and-maps/([A-Z0-9]{8}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{12}) /data-and-maps/ds_resolveuid/$1   [R=permanent,L]

    # Template service v2 , 21 June 2012
    RewriteRule ^/templates/v2/getRequiredHead /getRequiredHead
    RewriteRule ^/templates/v2/getHeader       /getHeader
    RewriteRule ^/templates/v2/getFooter       /getFooter

    RewriteRule ^/templates/v2/(..)/getRequiredHead /$1/getRequiredHead
    RewriteRule ^/templates/v2/(..)/getHeader       /$1/getHeader
    RewriteRule ^/templates/v2/(..)/getFooter       /$1/getFooter

    # Legal
    RewriteRule ^/coreset /data-and-maps/indicators [R,L]
    RewriteRule ^/copyright(.*) /legal/copyright$1 [R=permanent,L]
    RewriteRule ^/disclaimer(.*) /legal/disclaimer$1 [R=permanent,L]

    # SOER 2015 Launch rewrite rules. Ticket #22698#note-4
    RewriteRule ^/soer-2015$ /soer [R=permanent,L]
    RewriteRule ^/soer-2015/$ /soer [R=permanent,L]
    RewriteRule ^/soer-2015/view$ /soer [R=permanent,L]
    #RewriteRule ^/soer-2015/soer2015_frontpage$ /soer [R=permanent,L]

    # Rewrite RSS to RSS2 - this should be removed once the RSS enabling issue is fixed
    RewriteRule ^/(.*)highlights.rdf$ /$1highlights/archive/RSS2 [R,L]
    RewriteRule ^/(.*)reports.rdf$ /$1publications/latest/RSS2 [R,L]

    # Directive to ensure *.rdf files served as appropriate content type, if not present in main apache config
    AddType application/rdf+xml .rdf

    # Rewrite rule to serve RDF data from the proper location when Agent accepts the RDF data
    RewriteCond %{HTTP_ACCEPT} application/rdf\+xml.*
    RewriteCond %{REQUEST_URI} !^.*(@@rdf\/?|\.xml|\.rdf|\.rss|RSS|RSS2)$
    RewriteRule ^/(.*\/)$ $1@@rdf [R=303,L]

    RewriteCond %{HTTP_ACCEPT} application/rdf\+xml.*
    RewriteCond %{REQUEST_URI} !^.*(@@rdf\/?|\.xml|\.rdf|\.rss|RSS|RSS2)$
    RewriteRule ^/(.*)$ $1/@@rdf [R=303,L]

    # Control panel admin pages redirect to /www/.*
    RewriteRule ^/plone_control_panel(.*) /www/@@overview-controlpanel$1 [R=permanent,L,NE]
    RewriteRule ^/prefs_(.*) /www/prefs_$1 [R=permanent,L,NE]

    RewriteCond %{REQUEST_URI} !\.png$
    RewriteCond %{REQUEST_URI} !\.jpg$
    RewriteCond %{REQUEST_URI} !\.gif$
    RewriteCond %{REQUEST_URI} !\.css$
    RewriteCond %{REQUEST_URI} !\.js$
    RewriteRule ^/\+\+(.*)  https://%{HTTP_HOST}/www/++$1 [R=permanent,L,NE]

    RewriteCond %{REQUEST_URI} !^/@@rdf
    RewriteCond %{REQUEST_URI} !^/@@eea\.controlpanel
    RewriteCond %{REQUEST_URI} !^/@@manage-viewlets
    RewriteCond %{REQUEST_URI} !^/@@manage-portlets
    RewriteCond %{REQUEST_URI} !^/@@archetypes-querywidget-multipleselectionwidget
    RewriteRule ^/@@(.*) /www/@@$1 [R=permanent,L,NE]

    # zc.async queue 27705
    RewriteRule ^/jobs.json(.*) /www/jobs.json$1 [R=permanent,L,NE]

    # Due to #4836: fix for @@images
    RewriteRule ^(.*)/@@images/image/(.*) $1/image_$2 [R=permanent,L]

    ############################################################################
    # WARNING: DO NOT add anything else bellow. Add new rules above this comment
    ############################################################################
    RewriteCond %{REQUEST_URI} !^/server-status$
    RewriteCond %{REQUEST_URI} !^/errors/(.*)\.html$
    RewriteCond %{REQUEST_URI} !^/portal_css/(.*)\.css$
    RewriteCond %{REQUEST_URI} !^/portal_javascripts/(.*)\.js$
    
    SetEnvIf Request_URI "^/.*embed-chart" EMBED_PATH
    Header set X-Frame-Options "SAMEORIGIN" env=!EMBED_PATH
